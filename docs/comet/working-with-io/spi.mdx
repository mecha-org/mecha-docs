---
title: SPI
description: SPI over GPIO
keywords: [SPI, GPIO, Mecha Comet]
hide_table_of_contents: true
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

## Introduction to SPI

The Serial Peripheral Interface (SPI) is a synchronous, full-duplex serial communication protocol designed for high-speed data transfer between a master device (such as the Mecha Comet) and peripheral slave devices. It's commonly used to interface with sensors, displays, radio frequency (RF) modules, and other peripherals.

### **Advantages of SPI**

- **High-Speed Communication:** SPI supports significantly faster data transfer rates compared to protocols like I2C.
- **Low Latency:** SPI's synchronous nature makes it ideal for applications requiring minimal delay, such as real-time sensor readings and control systems.
- **Simplified Implementation:** SPI requires fewer wires and is generally less complex to implement than alternative communication protocols.

## SPI Pins on Mecha Comet

The Mecha Comet provides dedicated hardware SPI support through the following GPIO pins:

| Pin Name | GPIO Pin | Function |
| --- | --- | --- |
| **MOSI** | GPIO5_IO11 | Master Out Slave In |
| **MISO** | GPIO5_IO12 | Master In Slave Out |
| **SCLK** | GPIO5_IO10 | Serial Clock |
| **SS0** | GPIO5_IO13 | Slave Select |

These pins are pre-configured for hardware SPI communication, providing optimal performance. Access to these pins is facilitated through the `gpiod` library, which offers a modern and efficient interface for GPIO and peripheral control within the Linux kernel.

**Key SPI Concepts**

- **MOSI (Master Out Slave In):** The data line used by the master to transmit data to the slave.
- **MISO (Master In Slave Out):** The data line used by the slave to transmit data to the master.
- **SCLK (Serial Clock):** The clock signal generated by the master to synchronize data transfers.
- **SS (Slave Select) / CS (Chip Select):** An active-low signal used by the master to select a specific slave device.

---

## How SPI Works

The Mecha Comet utilizes its dedicated hardware SPI controller for efficient and reliable SPI communication. Interaction with the SPI interface is achieved through the `gpiod` library within the Debian operating system.

### Configuring SPI:

1. **Enable SPI**: Ensure SPI support is enabled in the kernel. For most Debian installations, this can be done using `modprobe spi_bcm2835` or similar commands.
2. **Set Up Pins**: Configure the GPIO pins for MOSI, MISO, SCLK, and SS using `gpiod`.
3. **Communicate**: Once the pins are configured, data can be sent and received over SPI by toggling these GPIO pins appropriately.

### Accessing SPI with `gpiod` in Debian

To use SPI with the `gpiod` library in Debian, you need to set up the GPIO pins and configure them for the appropriate role (input or output).

---

### Example Code Using `gpiod`

<Tabs
 defaultValue="python"
  values={[
    {label: 'Python', value: 'python'},
    {label: 'C', value: 'c'},
 
  ]}
>
  <TabItem value="python">    
        ### Using Python

        ```python
        import gpiod
        import time

        CHIP_PATH = "/dev/gpiochip0"
        MOSI_PIN = 11
        MISO_PIN = 12
        SCLK_PIN = 10
        SS0_PIN = 13

      def spi_init(chip):
            mosi = chip.get_line(MOSI_PIN)
            miso = chip.get_line(MISO_PIN)
            sclk = chip.get_line(SCLK_PIN)
            ss0 = chip.get_line(SS0_PIN)
        
            mosi.request(
                consumer="SPI_MOSI",
                type=gpiod.LINE_REQ_DIR_OUT,
                default_vals=[0]
            )
        
            miso.request(
                consumer="SPI_MISO",
                type=gpiod.LINE_REQ_DIR_IN
            )
        
            sclk.request(
                consumer="SPI_CLK",
                type=gpiod.LINE_REQ_DIR_OUT,
                default_vals=[0]
            )
        
            ss0.request(
                consumer="SPI_SS0",
                type=gpiod.LINE_REQ_DIR_OUT,
                default_vals=[1]  # Active low
            )
        
            return mosi, miso, sclk, ss0


        def spi_send(mosi, sclk, ss0, data):
            # Pull SS low to select the slave
            ss0.set_value(0)

            for i in range(7, -1, -1):
                bit = (data >> i) & 0x1
                sclk.set_value(0)  # Clock low
                mosi.set_value(bit)  # Set MOSI bit
                sclk.set_value(1)  # Clock high

            # Pull SS high to deselect the slave
            ss0.set_value(1)

        def main():
            chip = gpiod.Chip(CHIP_PATH)
            mosi, miso, sclk, ss0 = spi_init(chip)

            data_to_send = 0xAB
            spi_send(mosi, sclk, ss0, data_to_send)

            chip.close()

        if __name__ == "__main__":
            main()
        ```

        ### To Run the Python Program on the Mecha Comet:

        1. Save the code to a file, e.g., `spi_example.py`.

        2. Install the `gpiod` library if not already installed:

           ```bash
           sudo apt install python3-libgpiod
           ```

        3. Run the script with appropriate permissions:

           ```bash
           sudo python spi_example.py
           ```

           Ensure the SPI sensor is properly connected to the proper pins on the device before running the program.
        4. Check the output or behavior of the connected SPI device to verify successful communication.
     </TabItem>

  <TabItem value="c" >
        ### Using C

        ```c
        #include <gpiod.h>
        #include <stdio.h>
        #include <unistd.h>
    
        #define CHIP "/dev/gpiochip0" // Path to GPIO chip
        #define MOSI_PIN 11
        #define MISO_PIN 12
        #define SCLK_PIN 10
        #define SS0_PIN 13
    
        void spi_init(struct gpiod_chip *chip) {
            // Request GPIO pins
            struct gpiod_line *mosi = gpiod_chip_get_line(chip, MOSI_PIN);
            struct gpiod_line *miso = gpiod_chip_get_line(chip, MISO_PIN);
            struct gpiod_line *sclk = gpiod_chip_get_line(chip, SCLK_PIN);
            struct gpiod_line *ss0 = gpiod_chip_get_line(chip, SS0_PIN);
    
            // Set the pins as output or input
            gpiod_line_request_output(mosi, "SPI_MOSI", 0);
            gpiod_line_request_input(miso, "SPI_MISO");
            gpiod_line_request_output(sclk, "SPI_CLK", 0);
            gpiod_line_request_output(ss0, "SPI_SS0", 1); // Active low
        }
    
        void spi_send(struct gpiod_chip *chip, uint8_t data) {
            struct gpiod_line *mosi = gpiod_chip_get_line(chip, MOSI_PIN);
            struct gpiod_line *sclk = gpiod_chip_get_line(chip, SCLK_PIN);
            struct gpiod_line *ss0 = gpiod_chip_get_line(chip, SS0_PIN);
    
            // Select the slave (SS low)
            gpiod_line_set_value(ss0, 0);
    
            for (int i = 7; i >= 0; i--) {
                // Send each bit of data
                gpiod_line_set_value(sclk, 0); // Set clock low
                gpiod_line_set_value(mosi, (data >> i) & 1); // Set MOSI pin
                gpiod_line_set_value(sclk, 1); // Set clock high
            }
    
            // Deselect the slave (SS high)
            gpiod_line_set_value(ss0, 1);
        }
    
        int main() {
            struct gpiod_chip *chip = gpiod_chip_open_by_path(CHIP);
            if (!chip) {
                perror("Failed to open GPIO chip");
                return 1;
            }
    
            spi_init(chip);
    
            uint8_t data_to_send = 0xAB;  // Example data
            spi_send(chip, data_to_send);
    
            gpiod_chip_close(chip);
            return 0;
        }
        ```

        ### To Compile and Run the C Program on the Mecha Comet:

        To compile and run the provided C code on the Mecha Comet device, follow these steps:

        1. Save the code to a file, e.g., `spi_example.c`.

        2. Compile the code using the GCC compiler:

           ```bash
           gcc -o spi_example spi_example.c
           ```
        3. Install the `gpiod` library if not already installed:

           ```bash
           sudo apt-get install libgpiod-dev
           ```   

        4. Run the compiled program with appropriate permissions:

           ```bash
           sudo ./spi_example
           ```

           Ensure the SPI sensor is properly connected to the Proper pins on the device before running the program.



    </TabItem>

  <TabItem value="rust" >
    Rust Code Example
  </TabItem>
</Tabs>

---

## Use Cases

1. **Wireless Data Transmission (RF Communication)**
SPI facilitates high-speed data transfer with RF modules such as the nRF24L01, enabling reliable wireless communication in remote-controlled devices, sensor networks, and other applications requiring low-latency data exchange.
2. **Real-Time Robotic Control (RC Cars)**
SPI enables precise and rapid communication with motor controllers and sensors in remote-controlled cars, allowing for real-time control and feedback, crucial for responsive driving and accurate sensor data acquisition.
3. **Advanced Drone Control and Navigation**
SPI provides the necessary bandwidth for drones to communicate with critical components like GPS modules, accelerometers, gyroscopes, and other sensors. This high-speed data exchange is essential for stable flight control, accurate navigation, and real-time data logging.